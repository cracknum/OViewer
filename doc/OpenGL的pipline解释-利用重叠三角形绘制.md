## 一、场景设定
- 绘制两个三角形：
    - **三角形 A**：靠近相机（z = -1.0）
    - **三角形 B**：在 A 后方（z = -2.0），部分被 A 遮挡
- 启用深度测试：`glEnable(GL_DEPTH_TEST)`
- 使用标准 MVP 变换，正交或透视投影均可

---

## 二、完整渲染管线流程（从顶点到帧缓冲）

| 阶段                   | 输入                   | 处理                           | 输出                              | 关键说明                         |
|----------------------|----------------------|------------------------------|---------------------------------|------------------------------|
| **0. CPU 准备**        | 顶点数组、Uniforms        | 上传 VBO/UBO，绑定 Shader Program | —                               | 数据进入 GPU                     |
| **1. 顶点着色器 (VS)**    | 每顶点属性 + Uniform（MVP） | `gl_Position = MVP * pos`    | 裁剪空间坐标 `(x,y,z,w)` + 其他 out 变量  | ✅ per-vertex；输出齐次坐标          |
| **2. 图元装配**          | 顶点流                  | 按图元类型分组（如 GL_TRIANGLES）      | 完整图元（三角形）                       | 6 顶点 → 2 个三角形                |
| **3. 几何着色器 (GS)**    | 图元（可选）               | 动态生成/修改几何                    | 新图元（可选）                         | 本例未使用                        |
| **4. 裁剪 (Clipping)** | 裁剪空间中的图元             | 与视锥体比较，分割/丢弃                 | 裁剪后的图元（仍在裁剪空间）                  | ⚠️ 仍在 `(x,y,z,w)` 齐次坐标       |
| **5. 透视除法**          | 裁剪后顶点 `(x,y,z,w)`    | `(x/w, y/w, z/w)`            | NDC 坐标 ∈ [-1,1]                 | 齐次 → 非齐次                     |
| **6. 视口变换**          | NDC                  | 映射到屏幕像素 + 深度 [0,1]           | 窗口坐标 (pixel_x, pixel_y, depth)  | 由 `glViewport` 控制            |
| **7. 光栅化**           | 三角形                  | 生成覆盖的像素样本                    | 片段（fragment）列表                  | 每个片段含插值颜色、深度                 |
| **8. 片段着色器 (FS)**    | 插值属性                 | 计算最终颜色（光照/纹理）                | `fragColor` + 可选 `gl_FragDepth` | ✅ per-fragment；可能运行多次（即使被遮挡） |
| **9. 逐片段操作**         | 片段 + 帧缓冲当前值          | 深度测试、模板测试、混合等                | 决定是否写入                          | 🔑 深度测试剔除 B 的重叠部分            |
| **10. 写入帧缓冲**        | 通过测试的片段              | 更新 color/depth buffer        | 最终图像                            | A 可见，B 重叠部分不可见               |

> ✅ **关键结论**：
> - 深度测试发生在 FS **之后**（除非启用 early-z）。
> - 正确遮挡依赖：`glClear(GL_DEPTH_BUFFER_BIT)` + `glEnable(GL_DEPTH_TEST)`。

---

## 三、裁剪空间（Clip Space） vs 裁剪操作（Clipping）

| 项目          | 顶点着色器输出（阶段1）             | 裁剪阶段之后（阶段4）         |
|-------------|--------------------------|---------------------|
| **坐标名称**    | 裁剪空间坐标（Clip Coordinates） | 仍是裁剪空间坐标            |
| **数学形式**    | 齐次坐标 `(x, y, z, w)`      | 齐次坐标 `(x, y, z, w)` |
| **是否裁剪**    | ❌ 尚未裁剪                   | ✅ 已根据视锥体裁剪/分割       |
| **图元状态**    | 原始图元                     | 可能：保留 / 分割为新图元 / 丢弃 |
| **下一步**     | 进入裁剪阶段                   | 进入透视除法（→ NDC）       |
| **可见性判断依据** | `-w ≤ x,y,z ≤ w`         | 所有顶点均满足上述条件         |

### 📌 重要原则：
- **裁剪必须在齐次裁剪空间中进行**，不能在 NDC 中做。
- **透视除法（/w）只在裁剪完成后执行**，以保证插值正确性。
- 裁剪后坐标**仍叫“裁剪空间坐标”**，直到除以 w 才变成 NDC。

---

## 四、常见误区澄清

| 误区               | 正确理解                          |
|------------------|-------------------------------|
| “片段着色器处理每个像素”    | ❌ 只处理被图元覆盖的**片段**，背景像素不经过 FS  |
| “裁剪后坐标变成 NDC”    | ❌ 裁剪后仍是齐次裁剪空间，NDC 在透视除法后才出现   |
| “先画后面的物体会挡住前面的”  | ❌ 启用深度测试后，绘制顺序不影响最终可见性（但影响性能） |
| “glLineWidth 可靠” | ❌ 工业软件应使用 quad 或 GS 实现有宽度线段   |